<?php
namespace App\Http\Controllers;

use App\Models\Mod_Company;
use App\Models\Mod_Senderno;
use App\Models\MasterAccount;
use App\Models\Mod_User;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Hash;
use Illuminate\Support\Facades\Http;
use Illuminate\Support\Facades\Session;
use Illuminate\Support\Facades\DB;
use Illuminate\Support\Facades\Auth;
use Illuminate\Database\Eloquent\Builder;
use Spatie\QueryBuilder\AllowedFilter;
use Spatie\QueryBuilder\AllowedSort;
use Spatie\QueryBuilder\QueryBuilder;
use Symfony\Component\HttpFoundation\ParameterBag;

class M_Company extends Controller
{
    public function index(Request $request)
    {
		if(Session::get('userid'))
		{
			//jika memang session sudah terdaftar
			$username = Session::get('username');

			$sales  = DB::table('salesagent')
						->where('STATUS', 1)
						->select('SALESAGENTCODE','SALESAGENTNAME')
						->orderBy('SALESAGENTCODE','ASC')
						->get();

			$customer = DB::table('billing_ats.customer')
						->where('STATUSCODE', 'A')
						->where('PRODUCTID', 17)
						->select('CUSTOMERNO', 'CUSTOMERNAME')
						->orderBy('CUSTOMERNO','DESC')
						->get();

			if ($request->ajax()) 
			{
                dataTableGeneralSearch($request, function($search) {
                    return [
                        'filter' => [
                            'general_search' => $search
                        ]
                    ];
                });

				$data = QueryBuilder::for(Mod_Company::class)
						//->where('active', 1)
						->join('salesagent', 'salesagent.SALESAGENTCODE', '=', 'master_company.SALESAGENTCODE')	
						->join('master_paket_customer', 'master_paket_customer.customerno', '=', 'master_company.customerno')
						//->join('master_product_paket', 'master_product_paket.id', '=', 'master_paket_customer.product_paket_id') 
						->select('master_company.id','master_company.customerno','company_name','SALESAGENTNAME', DB::raw('(active) as factive'), DB::raw('(CASE WHEN product_paket_id < 5 THEN (SELECT product FROM master_product_paket WHERE master_product_paket.id = product_paket_id) ELSE (SELECT nama_paket FROM master_paket WHERE master_paket.id = product_paket_id) END) as paket'), DB::raw('(CASE WHEN active = 1 THEN "Active" ELSE "Inactive" END) as active'), 'fcompleted', DB::raw('(CASE WHEN fcompleted = 1 THEN "Completed" ELSE "Not Completed" END) as fcomplete'), 'fftp', DB::raw('(CASE WHEN fftp = 1 THEN "Ada FTP" ELSE "Tidak Ada FTP" END) as fftpdesc'))
						->orderBy('master_company.id','DESC')
						->allowedFilters(
							AllowedFilter::scope('general_search')
						)
						->paginate($request->query('perpage', 10))
						->appends(request()->query());

                return response()->paginator($data);
			}
			
			return view('home.master_company.company', compact('sales','customer'));
		}
		else
		{
			header("cache-Control: no-store, no-cache, must-revalidate");
			header("cache-Control: post-check=0, pre-check=0", false);
			header("Pragma: no-cache");
			header("Expires: Sat, 26 Jul 1997 05:00:00 GMT");

			Auth::logoutOtherDevices(Session::get('userid'));
			Auth::logoutOtherDevices(Session::get('realname'));
			Auth::logoutOtherDevices(Session::get('email'));
			Auth::logoutOtherDevices(Session::get('username'));
			Auth::logoutOtherDevices(Session::get('company_id'));
			Auth::logoutOtherDevices(Session::get('departemen_id'));
			Auth::logoutOtherDevices(Session::get('departemen'));
			Auth::logoutOtherDevices(Session::get('sex'));
			Auth::logoutOtherDevices(Session::get('login'));
			
			session()->forget('userid');
			session()->forget('realname');
			session()->forget('email');
			session()->forget('username');
			session()->forget('company_id');
			session()->forget('departemen_id');
			session()->forget('departemen');
			session()->forget('sex');
			session()->forget('login');
		
			session()->flush();
			Auth::logout();
			DB::disconnect('mysql');

			return redirect('http://192.168.100.100/app-portal/exit')->with('alert','You were Logout');
			echo "<script>window.close();</script>";
		}
	}
 
    public function autocompleteSearch(Request $request)
    {
        $query = $request->get('query');
		  
        $filterResult = DB::table('billing_ats.customer')->where('STATUSCODE', 'A')->whereIn('PRODUCTID', [17])->where('CUSTOMERNAME', 'LIKE', '%'.$query.'%')->select('CUSTOMERNAME')->get();
		//dd($data);

        $data = array();

        foreach ($filterResult as $hsl)
        {
            $data[] = $hsl->CUSTOMERNAME;
        }

        return response()->json($data);
    } 
	
    public function autocompleteLokalSearch(Request $request)
    {
        $query = $request->get('query');
		  
        $filterResult = DB::table('master_company')->where('invtypeid', '=', 2)->where('company_name', 'LIKE', '%'.$query.'%')->orWhere('customerno', 'LIKE', '%'.$query.'%')->select('customerno', 'company_name')->get();
		//dd($data);

        $data = array();

        foreach ($filterResult as $hsl)
        {
			$data[] = $hsl->customerno;
            $data[] = $hsl->company_name;
        }

        return response()->json($data);
    } 
	
    public function autocompletePeriodSearch(Request $request)
    {
        $query = $request->get('query');
		  
        $filterResult = DB::table('master_company')->where('invtypeid', '=', 1)->where('company_name', 'LIKE', '%'.$query.'%')->orWhere('customerno', 'LIKE', '%'.$query.'%')->select('customerno', 'company_name')->get();
		//dd($data);

        $data = array();

        foreach ($filterResult as $hsl)
        {
			$data[] = $hsl->customerno;
            $data[] = $hsl->company_name;
        }

        return response()->json($data);
    } 
	
	public function cariCustomer(Request $request, $id)
	{
		$data = DB::table('billing_ats.customer')
				->where('STATUSCODE', 'A')
				->whereIn('PRODUCTID', [17])
				->where('CUSTOMERNAME', 'LIKE', '%'.$id.'%')
				->select('CUSTOMERNO','CUSTOMERNAME','ACTIVATIONDATE','EMAIL','SALESAGENTCODE','DISCOUNT','NPWP','COMPANYNAME','NPWPADDRESS', 'BILLINGADDRESS1','BILLINGADDRESS2','BILLINGADDRESS3','BILLINGADDRESS4','BILLINGADDRESS5','ZIPCODE','ATTENTION',DB::raw('CASE WHEN PHONE1 IS NULL OR PHONE1 = "" THEN "-" ELSE CASE WHEN PHONE2 IS NULL OR PHONE2 = "" THEN PHONE1 ELSE CONCAT(PHONE1,"/",PHONE2) END END as PHONE'))
				->first();
		//dd($data);
		
		return response()->json($data);
	}
	
	public function cariLokalCustomer(Request $request, $id)
	{
		$data = DB::table('master_company')
                ->where('customerno', $id)
				->orWhere('company_name', $id)
				->select('master_company.id AS companyid','customerno','company_name')
				->first();
		//dd($data);
		
		return response()->json($data);
	}
	
	public function getcompany(Request $request)
	{
        $companyid = $request->cpy_name;

        $data = DB::table('billing_ats.customer')
					->where('STATUSCODE', 'A')
					->whereIn('PRODUCTID', [17])
					->select('CUSTOMERNO', 'CUSTOMERNAME', 'SALESAGENTCODE', 'BILLINGADDRESS1', 'BILLINGADDRESS2', 'BILLINGADDRESS3', 'BILLINGADDRESS4', 'BILLINGADDRESS5', 'ZIPCODE', 'PHONE1', 'COMPANYNAME', 'NPWP', 'NPWPADDRESS', 'EMAIL')
					->orderBy('CUSTOMERNO','DESC')
					->get();

		return response()->json($data);
        //echo json_encode($data);
    }
	
    public function delete_cust($id)
	{
		if(Session::get('userid'))
		{
	    	DB::table('master_company')->where('id',$id)->delete();    

	    	DB::connection('mysql_3')->table('master_company')->where('id',$id)->delete();    

	        return back()
	        		->with('success','Data Company was deleted successfully.');
		}
		else
		{
			header("cache-Control: no-store, no-cache, must-revalidate");
			header("cache-Control: post-check=0, pre-check=0", false);
			header("Pragma: no-cache");
			header("Expires: Sat, 26 Jul 1997 05:00:00 GMT");

			Auth::logoutOtherDevices(Session::get('userid'));
			Auth::logoutOtherDevices(Session::get('realname'));
			Auth::logoutOtherDevices(Session::get('email'));
			Auth::logoutOtherDevices(Session::get('username'));
			Auth::logoutOtherDevices(Session::get('company_id'));
			Auth::logoutOtherDevices(Session::get('departemen_id'));
			Auth::logoutOtherDevices(Session::get('departemen'));
			Auth::logoutOtherDevices(Session::get('sex'));
			Auth::logoutOtherDevices(Session::get('login'));
			
			session()->forget('userid');
			session()->forget('realname');
			session()->forget('email');
			session()->forget('username');
			session()->forget('company_id');
			session()->forget('departemen_id');
			session()->forget('departemen');
			session()->forget('sex');
			session()->forget('login');
		
			session()->flush();
			Auth::logout();
			DB::disconnect('mysql');

			return redirect('http://192.168.100.100/app-portal/exit')->with('alert','You were Logout');
			echo "<script>window.close();</script>";
		}
    }

	public function view_cust($id)
    {
        if(Session::get('userid'))
        {
			$datas	= DB::table('master_company')->where('id', $id)->where('fftp', 1)->first();
			
			if(!empty($datas) || $datas != null)
			{
				$data = DB::table('master_company')
						->where('master_company.id', $id)
						->where('master_company.active', 1)
						->where('fftp', 1)
						->join('salesagent', 'salesagent.SALESAGENTCODE', '=', 'master_company.SALESAGENTCODE')	
						->join('master_paket_customer', 'master_paket_customer.customerno', '=', 'master_company.customerno')
						//->join('master_product_paket', 'master_product_paket.id', '=', 'master_paket_customer.product_paket_id') 
						->leftJoin('master_ftp', 'master_ftp.companyid', '=', 'master_company.id')	
						->select('master_company.id','master_company.customerno','company_name','address','address2','address3','address4','address5','zipcode','address_npwp','phone_fax','email_pic','email_billing','npwpno','npwpname','master_company.SALESAGENTCODE','SALESAGENTNAME','activation_date','notes',DB::raw('(master_company.active) as factive'), DB::raw('(CASE WHEN master_company.active = 1 THEN "Active" ELSE "Inactive" END) as active'), 'master_paket_customer.product_paket_id', DB::raw('(CASE WHEN product_paket_id < 5 THEN (SELECT product FROM master_product_paket WHERE master_product_paket.id = product_paket_id) ELSE (SELECT nama_paket FROM master_paket WHERE master_paket.id = product_paket_id) END) as paket'), 'master_company.invtypeid', DB::raw('(CASE WHEN master_company.invtypeid = 1 THEN "Invoice Periodic" WHEN master_company.invtypeid = 2 THEN "Invoice Monthly" END) as invtype'), 'master_company.fcompleted', DB::raw('(CASE WHEN master_company.fcompleted = 1 THEN "Completed" ELSE "Not Completed" END) as fcomplete'), 'fftp', DB::raw('(CASE WHEN fftp = 1 THEN "Ada FTP" ELSE "Tidak Ada FTP" END) as fftpdesc'), 'ip_ftp', 'username', 'passwd', 'jam_awal_download', 'jam_akhir_download', 'folder_download', 'jam_awal_upload', 'jam_akhir_upload', 'folder_upload' , 'pic_email', 'protocol', 'port', 'folderlokal')
						->first();

				return response()->json($data);
			}
			else
			{
				$data = DB::table('master_company')
						->where('master_company.id', $id)
						->where('master_company.active', 1)
						->where('fftp', 0)
						->join('salesagent', 'salesagent.SALESAGENTCODE', '=', 'master_company.SALESAGENTCODE')	
						->join('master_paket_customer', 'master_paket_customer.customerno', '=', 'master_company.customerno')
						->leftJoin('master_user_appglobal', 'master_user_appglobal.company_id', '=', 'master_company.id')	
						->leftJoin('master_ftp', 'master_ftp.companyid', '=', 'master_company.id')	
						->select('master_company.id','master_company.customerno','company_name','address','address2','address3','address4','address5','zipcode','address_npwp','phone_fax','email_pic','email_billing','npwpno','npwpname','master_company.SALESAGENTCODE','SALESAGENTNAME','activation_date','notes',DB::raw('(master_company.active) as factive'), DB::raw('(CASE WHEN master_company.active = 1 THEN "Active" ELSE "Inactive" END) as active'), 'master_paket_customer.product_paket_id', DB::raw('(CASE WHEN product_paket_id < 5 THEN (SELECT product FROM master_product_paket WHERE master_product_paket.id = product_paket_id) ELSE (SELECT nama_paket FROM master_paket WHERE master_paket.id = product_paket_id) END) as paket'), 'master_company.invtypeid', DB::raw('(CASE WHEN master_company.invtypeid = 1 THEN "Invoice Periodic" WHEN master_company.invtypeid = 2 THEN "Invoice Monthly" END) as invtype'), 'master_company.fcompleted', DB::raw('(CASE WHEN master_company.fcompleted = 1 THEN "Completed" ELSE "Not Completed" END) as fcomplete'), 'fftp', DB::raw('(CASE WHEN fftp = 1 THEN "Ada FTP" ELSE "Tidak Ada FTP" END) as fftpdesc'), 'master_user_appglobal.username', 'master_user_appglobal.password', 'master_user_appglobal.passwd', 'master_user_appglobal.full_name', 'master_user_appglobal.divisi_name', DB::raw('(CASE WHEN master_user_appglobal.active = 1 THEN "Active" ELSE "Inactive" END) as factivenonftp'), 'master_user_appglobal.folder')
						->first();

				return response()->json($data);
			}
        }
        else
        {
			header("cache-Control: no-store, no-cache, must-revalidate");
			header("cache-Control: post-check=0, pre-check=0", false);
			header("Pragma: no-cache");
			header("Expires: Sat, 26 Jul 1997 05:00:00 GMT");

			Auth::logoutOtherDevices(Session::get('userid'));
			Auth::logoutOtherDevices(Session::get('realname'));
			Auth::logoutOtherDevices(Session::get('email'));
			Auth::logoutOtherDevices(Session::get('username'));
			Auth::logoutOtherDevices(Session::get('company_id'));
			Auth::logoutOtherDevices(Session::get('departemen_id'));
			Auth::logoutOtherDevices(Session::get('departemen'));
			Auth::logoutOtherDevices(Session::get('sex'));
			Auth::logoutOtherDevices(Session::get('login'));
			
			session()->forget('userid');
			session()->forget('realname');
			session()->forget('email');
			session()->forget('username');
			session()->forget('company_id');
			session()->forget('departemen_id');
			session()->forget('departemen');
			session()->forget('sex');
			session()->forget('login');
		
			session()->flush();
			Auth::logout();
			DB::disconnect('mysql');

			return redirect('http://192.168.100.100/app-portal/exit')->with('alert','You were Logout');
			echo "<script>window.close();</script>";
		}
    }

	public function view_ftp($id)
    {
        if(Session::get('userid'))
        {
			//id,company_id,username,password,passwd,full_name,divisi_name,group_id,active,createdby,createddate,updby,upddate,folder
			
			$data = DB::table('master_company')
					->where('master_company.id', $id)
					->where('master_company.active', 1)
					->leftJoin('master_user_appglobal', 'master_user_appglobal.company_id', '=', 'master_company.id')	
					->select('master_company.id','master_company.customerno','company_name', DB::raw('(CASE WHEN fftp = 1 THEN "Ada FTP" ELSE "Tidak Ada FTP" END) as fftpdesc'), 'username', 'password', 'passwd', 'full_name', 'divisi_name', DB::raw('(master_user_appglobal.active) as factive'), 'folder')
					->first();

			return response()->json($data);
        }
        else
        {
			header("cache-Control: no-store, no-cache, must-revalidate");
			header("cache-Control: post-check=0, pre-check=0", false);
			header("Pragma: no-cache");
			header("Expires: Sat, 26 Jul 1997 05:00:00 GMT");

			Auth::logoutOtherDevices(Session::get('userid'));
			Auth::logoutOtherDevices(Session::get('realname'));
			Auth::logoutOtherDevices(Session::get('email'));
			Auth::logoutOtherDevices(Session::get('username'));
			Auth::logoutOtherDevices(Session::get('company_id'));
			Auth::logoutOtherDevices(Session::get('departemen_id'));
			Auth::logoutOtherDevices(Session::get('departemen'));
			Auth::logoutOtherDevices(Session::get('sex'));
			Auth::logoutOtherDevices(Session::get('login'));
			
			session()->forget('userid');
			session()->forget('realname');
			session()->forget('email');
			session()->forget('username');
			session()->forget('company_id');
			session()->forget('departemen_id');
			session()->forget('departemen');
			session()->forget('sex');
			session()->forget('login');
		
			session()->flush();
			Auth::logout();
			DB::disconnect('mysql');

			return redirect('http://192.168.100.100/app-portal/exit')->with('alert','You were Logout');
			echo "<script>window.close();</script>";
		}
    }

	public function update_cust(Request $request)
	{
		if(Session::get('userid'))
        {
			$data 				= array();
			$editid				= $request->id2;
			$current_date_time 	= date('Y-m-d H:i:s');
			//dd($editid);
			
			$data = array(
				'company_name' => $request->cpy_name2, 
				'address' => $request->cpy_addr21, 
				'address2' => $request->cpy_addr22, 
				'address3' => $request->cpy_addr23, 
				'address4' => $request->cpy_addr24, 
				'address5' => $request->cpy_addr25, 
				'zipcode' => $request->cpy_zipcode2, 
				'npwpno' => $request->npwpno2,
				'npwpname' => $request->npwpname2,
				'address_npwp' => $request->bill_addr2, 
				'phone_fax' => $request->phone2, 
				'email_pic' => $request->cpy_email2, 
				'email_billing' => $request->bill_email2, 
				'SALESAGENTCODE' => $request->sales2,
				'notes'  => $request->notes2, 
				'activation_date' => $request->startdate2, 
				'invtypeid' => $request->invtype2,
				'active' => $request->status2,
				'fftp' => $request->fftp,
				'update_by' => $request->updby
			);

			Mod_Company::Update_Cpy($editid, $data);
			
			if($request->fftp == 1)
			{
				$ip_ftp 			= $request->ip_ftp2;
				$username 			= $request->username2;
				$password 			= $request->passwd2;
				$jam_awal_download 	= $request->start_time2;
				$jam_akhir_download = $request->end_time2;
				$folder_download	= $request->folderdown2;
				$jam_awal_upload 	= $request->start_time22;
				$jam_akhir_upload 	= $request->end_time22;
				$folder_upload		= $request->folderup2;
				$pic_email			= $request->emailnotif2;
				$protocol			= $request->protocol2;
				$port				= $request->port2;
					
				$data1	= DB::table('master_ftp')->where('companyid', $editid)->first();
				
				if(!empty($data1) || $data1 != null)
				{
					DB::table('master_ftp')
						->where('master_ftp.companyid', $editid)
						->update(
							[
								'ip_ftp'				=> $ip_ftp,
								'username'				=> $username,
								'passwd'				=> $password,
								'jam_awal_download'		=> $jam_awal_download,
								'jam_akhir_download'	=> $jam_akhir_download,
								'folder_download' 		=> $folder_download,
								'jam_awal_upload' 		=> $jam_awal_upload,
								'jam_akhir_upload' 		=> $jam_akhir_upload,
								'folder_upload' 		=> $folder_upload,
								'pic_email' 			=> $pic_email,
								'protocol' 				=> $protocol,
								'port' 					=> $port,
								'update_by' 			=> $request->updby,
								'update_at'				=> date('Y-m-d H:i:s')
							]);
							
					DB::connection('mysql_3')->table('master_ftp')
						->where('master_ftp.companyid', $editid)
						->update(
							[
								'ip_ftp'				=> $ip_ftp,
								'username'				=> $username,
								'passwd'				=> $password,
								'jam_awal_download'		=> $jam_awal_download,
								'jam_akhir_download'	=> $jam_akhir_download,
								'folder_download' 		=> $folder_download,
								'jam_awal_upload' 		=> $jam_awal_upload,
								'jam_akhir_upload' 		=> $jam_akhir_upload,
								'folder_upload' 		=> $folder_upload,
								'pic_email' 			=> $pic_email,
								'protocol' 				=> $protocol,
								'port' 					=> $port,
								'update_by' 			=> $request->updby,
								'update_at'				=> date('Y-m-d H:i:s')
							]);
				}
				else
				{
					DB::table('master_ftp')->insert(
						[
							'companyid' 			=> $editid,
							'ip_ftp' 				=> $ip_ftp,
							'username' 				=> $username,
							'passwd' 				=> $password,
							'jam_awal_download' 	=> $jam_awal_download,
							'jam_akhir_download' 	=> $jam_akhir_download,
							'folder_download' 		=> $folder_download,
							'jam_awal_upload' 		=> $jam_awal_upload,
							'jam_akhir_upload' 		=> $jam_akhir_upload,
							'folder_upload' 		=> $folder_upload,
							'pic_email' 			=> $pic_email,
							'protocol' 				=> $protocol,
							'port' 					=> $port,
							'update_by' 			=> $request->updby,
							'update_at' 			=> date('Y-m-d H:i:s')
						]
					);
					
					DB::connection('mysql_3')->table('master_ftp')->insert(
						[
							'companyid' 			=> $editid,
							'ip_ftp' 				=> $ip_ftp,
							'username' 				=> $username,
							'passwd' 				=> $password,
							'jam_awal_download' 	=> $jam_awal_download,
							'jam_akhir_download' 	=> $jam_akhir_download,
							'folder_download' 		=> $folder_download,
							'jam_awal_upload' 		=> $jam_awal_upload,
							'jam_akhir_upload' 		=> $jam_akhir_upload,
							'folder_upload' 		=> $folder_upload,
							'pic_email' 			=> $pic_email,
							'protocol' 				=> $protocol,
							'port' 					=> $port,
							'update_by' 			=> $request->updby,
							'update_at' 			=> date('Y-m-d H:i:s')
						]
					);
				}
			}
			else
			{
				DB::table('master_ftp')->where('master_ftp.companyid',$editid)->delete(); 
				DB::connection('mysql_3')->table('master_ftp')->where('master_ftp.companyid',$editid)->delete(); 
			}

			return back()
	            ->with('success','Master Customer was updated successfully.');
		}
		else
		{
            //jika session belum terdaftar, maka redirect ke halaman login
			header("cache-Control: no-store, no-cache, must-revalidate");
			header("cache-Control: post-check=0, pre-check=0", false);
			header("Pragma: no-cache");
			header("Expires: Sat, 26 Jul 1997 05:00:00 GMT");

			Auth::logoutOtherDevices(Session::get('userid'));
			Auth::logoutOtherDevices(Session::get('realname'));
			Auth::logoutOtherDevices(Session::get('email'));
			Auth::logoutOtherDevices(Session::get('username'));
			Auth::logoutOtherDevices(Session::get('company_id'));
			Auth::logoutOtherDevices(Session::get('departemen_id'));
			Auth::logoutOtherDevices(Session::get('departemen'));
			Auth::logoutOtherDevices(Session::get('sex'));
			Auth::logoutOtherDevices(Session::get('login'));
			
			session()->forget('userid');
			session()->forget('realname');
			session()->forget('email');
			session()->forget('username');
			session()->forget('company_id');
			session()->forget('departemen_id');
			session()->forget('departemen');
			session()->forget('sex');
			session()->forget('login');
		
			session()->flush();
			Auth::logout();
			DB::disconnect('mysql');

			return redirect('http://192.168.100.100/app-portal/exit')->with('alert','You were Logout');
			echo "<script>window.close();</script>";
		}
	}

	public function update_ftp(Request $request)
	{
		if(Session::get('userid'))
        {					  
			//id,company_id,username,password,passwd,full_name,divisi_name,group_id,active,createdby,createddate,updby,upddate,folder			
			$company_id		= $request->id3;
			$customerno		= $request->custno3;
			//dd($editid);
			
			$username		= $request->username3;
			$password		= $request->passwd3;
			$passwd			= $request->cpasswd3;
			$full_name		= $request->fullname3;
			$divisi_name	= $request->divname3;
			$folder			= $request->folname3;
			$active			= $request->status3;
			$updby			= Session::get('userid');
				
			$datax	= DB::table('master_user_appglobal')->where('company_id', $company_id)->first();
			
			if(empty($datax) || $datax == null)
			{
				DB::table('master_user_appglobal')->insert(
					[
						'company_id'	=> $company_id,
						'username'		=> $username,
						'password'		=> Hash::make($password),
						'passwd'		=> $passwd,
						'full_name'		=> $full_name,
						'divisi_name'	=> $divisi_name,
						'group_id'		=> 2,
						'active'		=> 1,
						'createdby'		=> $updby,
						'createddate'	=> date('Y-m-d H:i:s'),
						'folder'		=> $folder
					]
				);
			}
			else
			{
				DB::table('master_user_appglobal')
					->where('master_user_appglobal.company_id', $company_id)
					->update(
						[
							'username'		=> $username,
							'password'		=> Hash::make($password),
							'passwd'		=> $passwd,
							'full_name'		=> $full_name,
							'divisi_name'	=> $divisi_name,
							'active' 		=> $active,
							'updby'			=> $updby,
							'upddate'		=> date('Y-m-d H:i:s'),
							'folder' 		=> $folder
						]);
			}

			return back()
	            ->with('success','Master Non FTP Customer was updated successfully.');
		}
		else
		{
            //jika session belum terdaftar, maka redirect ke halaman login
			header("cache-Control: no-store, no-cache, must-revalidate");
			header("cache-Control: post-check=0, pre-check=0", false);
			header("Pragma: no-cache");
			header("Expires: Sat, 26 Jul 1997 05:00:00 GMT");

			Auth::logoutOtherDevices(Session::get('userid'));
			Auth::logoutOtherDevices(Session::get('realname'));
			Auth::logoutOtherDevices(Session::get('email'));
			Auth::logoutOtherDevices(Session::get('username'));
			Auth::logoutOtherDevices(Session::get('company_id'));
			Auth::logoutOtherDevices(Session::get('departemen_id'));
			Auth::logoutOtherDevices(Session::get('departemen'));
			Auth::logoutOtherDevices(Session::get('sex'));
			Auth::logoutOtherDevices(Session::get('login'));
			
			session()->forget('userid');
			session()->forget('realname');
			session()->forget('email');
			session()->forget('username');
			session()->forget('company_id');
			session()->forget('departemen_id');
			session()->forget('departemen');
			session()->forget('sex');
			session()->forget('login');
		
			session()->flush();
			Auth::logout();
			DB::disconnect('mysql');

			return redirect('http://192.168.100.100/app-portal/exit')->with('alert','You were Logout');
			echo "<script>window.close();</script>";
		}
	}
}
